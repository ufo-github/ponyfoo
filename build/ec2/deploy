#!/bin/bash

# locals
ENV="staging"
NAME="ponyfoo-$ENV"
KEYFILE="deploy/keys/$ENV"
EMOJI="$(emoji-random)"

# instance-specific
INSTANCE_USER=$(cat $KEYFILE.user)
INSTANCE_ID=$(cat $KEYFILE.id)
PUBLIC_DNS=$(cat $KEYFILE.dns)

APP="~/apps/$ENV"
APP_VERSIONS="$APP/v"
APP_LIVE="$APP/live"
APP_CONFIG="$APP/config"
APP_SCRIPT="$APP_LIVE/cluster.js"
RSYNC="~/apps/.rsync/$ENV"
RSYNC_MAILTUBE="$RSYNC/mailtube"
RSYNC_REPO="$RSYNC/app/"

# bump package.json
git add .
git commit -am "Pre-deploy commit because $EMOJI"
npm version patch -m "Upgrade to %s because deploy $EMOJI"
VERSION=$(cat package.json | jq .version)

APP_LATEST="$APP_VERSIONS/$VERSION"

# build for release
npm run release

# upload modifications
rsync \
  -az \
  --stats \
  --delete \
  --exclude-from .rsyncignore \
  -e "ssh -i $KEYFILE -o StrictHostKeyChecking=no" \
  . \
  $INSTANCE_USER@$PUBLIC_DNS:$RSYNC_REPO

# jump into instance
ssh -Ti $KEYFILE -o StrictHostKeyChecking=no $INSTANCE_USER@$PUBLIC_DNS << EOF_DEPLOY
  cluster_start () {
    echo "Initializing cluster..."
    cp $RSYNC_MAILTUBE/upstart/pony.conf $APP/$NAME.conf
    NODE_BIN="\$NVM_BIN/node"
    sed -i "s#{NAME}#$NAME#g" $APP/$NAME.conf
    sed -i "s#{USER}#$INSTANCE_USER#g" $APP/$NAME.conf
    sed -i "s#{NODE_BIN}#$NODE_BIN#g" $APP/$NAME.conf
    sed -i "s#{APP_SCRIPT}#$APP_SCRIPT#g" $APP/$NAME.conf
    sudo ln -sfn $APP/$NAME.conf /etc/init/$NAME.conf
    start $NAME
  }

  cluster_start_or_reload () {
    CLUSTER_PID = "$(cat .pid)"
    SUCCESS="$?"
    if [ "$SUCCESS" == "0" ] ; then
      echo "Reloading cluster..."
      kill -s SIGUSR2 $CLUSTER_PID
    else
      cluster_start
    fi
  }

  rm -rf $APP_LATEST
  cp -r $RSYNC_REPO $APP_LATEST
  ln -sfn $APP_LATEST $APP_LIVE
  ln -sfn $APP_CONFIG $APP_LATEST/.env
  rm -rf `ls -t $APP_VERSIONS | tail -n +11`
  npm --prefix $APP_LATEST install --production
  sudo nginx -s reload || sudo service nginx start || (sudo cat /var/log/nginx/error.log && exit 1)
  cluster_start_or_reload
EOF_DEPLOY

echo "Deployed v$VERSION to $ENV"
